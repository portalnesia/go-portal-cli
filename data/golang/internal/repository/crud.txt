package repository

import (
	"APP_NAME/internal/context"
	"APP_NAME/internal/request"
)

type DataModel interface {
	GetAvailableOrder() [][]string
	GetDefaultOrder() []string // [sort,order]
	TableName() string
}

type CrudRepository[Model DataModel, TypeID any, Filter request.RequestInterface] interface {
	FindOne(ctx *context.Context, query *request.Request, id TypeID, opts ...Options) (resp *Model, err error)
	FindAll(ctx *context.Context, query Filter, opts ...Options) (resp []Model, err error)
	Create(ctx *context.Context, query *request.Request, data *Model, opts ...Options) (err error)
	Update(ctx *context.Context, query *request.Request, data *Model, opts ...Options) (err error)
	Delete(ctx *context.Context, query *request.Request, id TypeID, opts ...Options) (err error)
}

type crudRepository[Model DataModel, TypeID any, Filter request.RequestInterface] struct {
	base
}

func (r crudRepository[Model, TypeID, Filter]) FindOne(ctx *context.Context, query *request.Request, id TypeID, opts ...Options) (resp *Model, err error) {
	db := r.getDatabase(ctx, opts...)

	if err = db.Where("id = ?", id).First(&resp).Error; err != nil {
		return nil, err
	}

	return
}

func (r crudRepository[Model, TypeID, Filter]) FindAll(ctx *context.Context, query Filter, opts ...Options) (resp []Model, err error) {
	var tmp Model
	db := r.getDatabase(ctx, opts...).Model(tmp)

	var total int64
	db.Model(&tmp).Count(&total)
	query.SetTotal(total)

	if err = db.Scopes(query.ListHelper(tmp.GetDefaultOrder(), tmp.GetAvailableOrder(), tmp.TableName())).Find(&resp).Error; err != nil {
		return nil, err
	}

	if query.GetPage() == 0 {
		lenData := len(resp)
		if lenData > 0 {
			cursorResponse, _ := request.ExtractValuesByColumns(&resp[lenData-1], query.GetOrder())
			query.SetCursorResponse(cursorResponse)
		}
	}

	return
}

func (r crudRepository[Model, TypeID, Filter]) Create(ctx *context.Context, query *request.Request, data *Model, opts ...Options) (err error) {
	db := r.getDatabase(ctx, opts...)

	return db.Create(&data).Error
}

func (r crudRepository[Model, TypeID, Filter]) Update(ctx *context.Context, query *request.Request, data *Model, opts ...Options) (err error) {
	db := r.getDatabase(ctx, opts...)

	return db.Save(&data).Error
}

func (r crudRepository[Model, TypeID, Filter]) Delete(ctx *context.Context, query *request.Request, id TypeID, opts ...Options) (err error) {
	var tmp Model
	db := r.getDatabase(ctx, opts...)

	return db.Where("id = ?", id).Delete(&tmp).Error
}
